!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function Editor(e){this.editor=e,this.delay=DELAY,this.onChange=function(){},this._oldSource=null,this._timer=null,this.setListeners()}module.exports=Editor;const DELAY=800;Editor.prototype.setListeners=function(){var e=this,t=e.editor;t.on("cursorActivity",e.scheduleBuild.bind(e)),t.on("focus",e.scheduleBuild.bind(e)),t.on("keydown",e.scheduleBuild.bind(e)),t.on("keypress",e.scheduleBuild.bind(e)),t.on("keyup",e.scheduleBuild.bind(e)),t.on("mousedown",e.scheduleBuild.bind(e)),t.on("mouseup",e.scheduleBuild.bind(e))},Editor.prototype.scheduleBuild=function(){var e=this;e.editor.getValue()===e._oldSource||(null!==e._timer&&(clearTimeout(e._timer),e._timer=null),e._timer=setTimeout(function(){e.build(),e._timer=null},e.delay))},Editor.prototype.build=function(e){var t=this,i=t.editor,o=i.getValue();t._oldSource=o,t.onChange(o,e)},Editor.prototype.setValue=function(e){this.editor.setValue(e),this.scheduleBuild()},Editor.prototype.deactivate=function(){this.editor.setOption("readOnly","nocursor")},Editor.prototype.reactivate=function(){this.editor.setOption("readOnly",!1)},Editor.prototype.highlight=function(e){var t=this.editor,i=e.location,o="marker mark-"+e.event.replace(":","-");return t.markText({line:i.start.line-1,ch:i.start.column-1},{line:i.end.line-1,ch:i.end.column-1},{className:o})||{clear:function(){}}}},{}],2:[function(require,module,exports){function updateQueryString(t,e,i){i||(i=window.location.href);var r,o=new RegExp("([?&])"+t+"=.*?(&|#|$)(.*)","gi");if(o.test(i))return void 0!==e&&null!==e?i.replace(o,"$1"+t+"="+e+"$2$3"):(r=i.split("#"),i=r[0].replace(o,"$1$3").replace(/(&|\?)$/,""),void 0!==r[1]&&null!==r[1]&&(i+="#"+r[1]),i);if(void 0!==e&&null!==e){var n=-1!==i.indexOf("?")?"&":"?";return r=i.split("#"),i=r[0]+n+t+"="+e,void 0!==r[1]&&null!==r[1]&&(i+="#"+r[1]),i}return i}function getParameterByName(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=e.exec(window.location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))}function getTime(){var t=new Date;return("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)}function ExecutionTimer(){this.startDate=new Date,this.endDate=null,this.maxExecutionTime=ExecutionTimer.MAXEXECUTIONTIME,this.timer=null,this.onExceed=function(){}}var Editor=require("./editor"),Parser=require("./parser"),Solver=require("./solver"),util=require("./util");$(document).ready(function(){function t(t){v.queryInput.val(""),v.spinner.hide(),v.queryButton.prop("disabled",!1),v.clearStore.prop("disabled",!1),h(),o(),t&&t.store&&i(t.store),0===S&&(S=null)}function e(){v.switchTracing.bootstrapSwitch("state")||(v.timeoutErrorNotification.find(".mesg").text("The solver uses more time to terminate than normal. Do you want to trace the program?"),util.show(v.timeoutErrorNotification),v.spinner.hide(),v.switchTracing.bootstrapSwitch("disabled",!1),v.switchTracing.bootstrapSwitch("state",!0),v.switchTracing.bootstrapSwitch("disabled",!0),n())}function i(t){return v.store.empty(),0===t.length?(v.store.append("<tr><td></td><td>(empty)</td></tr>"),void v.clearStore.hide()):(t.forEach(function(t){var e='<tr data-constraint-id="'+t.id+'"><td>'+t.id+"</td><td><code>"+t.string+"</code>";e+='<button type="button" title="Remove" class="close remove-constraint" data-constraint-id="'+t.id+'">Ã—</button>',e+="</td></tr>",v.store.append(e),v.store.find("button.remove-constraint").on("click",c),v.store.find("button.reactivate-constraint").on("click",r)}),void v.clearStore.show())}function r(){}function o(){$("#tracer-play").show().prop("disabled","disabled"),$("#tracer-pause").hide().prop("disabled","disabled"),$("#tracer-continue").prop("disabled","disabled"),$("#tracer-end").prop("disabled","disabled"),$("#tracer-abort").prop("disabled","disabled")}function n(){$("#tracer-play").show().prop("disabled",!1),$("#tracer-pause").hide().prop("disabled","disabled"),$("#tracer-continue").prop("disabled",!1),$("#tracer-end").prop("disabled",!1),$("#tracer-abort").prop("disabled",!1)}function c(t){var e;e="string"==typeof t?t:$(this).data("constraintId"),m.killConstraint(e),v.store.find('tr[data-constraint-id="'+e+'"]').remove(),0===v.store.find("tr").length&&(v.store.append("<tr><td></td><td>(empty)</td></tr>"),$("#clearStore").hide())}function a(){v.store.find("tr").each(function(t){$(this).attr("data-constraint-id")&&c($(this).attr("data-constraint-id"))})}function d(t){t=t||{};var e=new Gister({isAnonymous:!0});e.on("created",function(t){v.spinner.hide();var e=updateQueryString("gist",t.id);window.history.replaceState({},"Gist: "+t.id,e)}),e.on("error",function(t){v.spinner.hide(),v.gistErrorNotification.find(".mesg").text(t.toString())}),e.create({"chrjs.chr":T.getValue()})}function p(t){if(t.event&&("store:add"===t.event||"store:remove"===t.event))return void($('input[data-event="'+t.event+'"]').is(":checked")&&l(t));if(b=x.highlight(t),v.spinner.hide(),t&&t.store&&i(t.store),t&&t.event&&!$('input[data-event="'+t.event+'"]').is(":checked"))return b.clear(),v.spinner.show(),void m.continueBreakpoint();if(l(t),$("#tracer-pause").is(":visible")){var e=1e3*parseInt(v.tracerSpeed.val(),10);e=Math.max(0,e),w=setTimeout(function(){b.clear(),v.spinner.show(),m.continueBreakpoint()},e)}}function l(t){var e="";"string"==typeof t?e=t:"rule:try"===t.event?e='Try rule "'+t.rule+'" for '+t.constraint:"rule:try-occurrence"===t.event?e="Try occurrence "+t.occurrence+" for "+t.constraint:"store:add"===t.event?e="Added constraint "+t.constraintString+" to the store":"store:remove"===t.event&&(e="Removed constraint "+t.constraintString+" from the store");var i="<p><code>["+getTime()+"] "+e+"</code></p>";v.traceLogPanel.append(i),v.traceLogPanel.animate({scrollTop:v.traceLogPanel.prop("scrollHeight")},600)}function f(){x.deactivate(),v.compileButton.prop("disabled","disabled"),v.switchAutocompilation.bootstrapSwitch("disabled",!0),v.switchPersistentStore.bootstrapSwitch("disabled",!0),v.switchTracing.bootstrapSwitch("disabled",!0)}function h(){x.reactivate(),v.compileButton.prop("disabled",!1),v.switchAutocompilation.bootstrapSwitch("disabled",!1),v.switchPersistentStore.bootstrapSwitch("disabled",!1),v.switchTracing.bootstrapSwitch("disabled",!1)}var g,m,b,w,v={notifications:$("#notifications > *"),spinner:$("#spinner"),parsingErrorNotification:$("#notification-parsing-error"),queryErrorNotification:$("#notification-query-error"),gistErrorNotification:$("#notification-gist-error"),timeoutErrorNotification:$("#notification-timeout-error"),queryButton:$("#query button"),queryInput:$("#query input"),compileButton:$("#compile-button"),store:$("#store tbody"),clearStore:$("#clear-store"),switchAutocompilation:$('input[name="cb-live-compilation"]'),switchPersistentStore:$('input[name="cb-persistent-store"]'),switchTracing:$('input[name="cb-tracing"]'),switchTraceAutoplay:$('input[name="cb-trace-autoplay"]'),gistSave:$("#gist-save"),traceLog:$("#trace-log"),traceLogPanel:$("#trace-log .panel-body"),tracerSettings:$("#tracer-settings .dropdown-menu"),tracerSettingsOptions:$('#tracer-settings .dropdown-menu a:has(input[type="checkbox"])'),tracerSpeed:$("#tracer-speed")},y=[],S=null;(function(){v.compileButton.hide(),$('[data-type="switch"]').bootstrapSwitch(),v.switchAutocompilation.on("switchChange.bootstrapSwitch",function(t,e){e?(v.compileButton.fadeOut(),x.build({forced:!0})):(v.compileButton.fadeIn(),v.parsingErrorNotification.fadeOut())}),v.switchTracing.on("switchChange.bootstrapSwitch",function(t,e){e?v.traceLog.slideDown():v.traceLog.slideUp()}),v.gistSave.click(function(){d({public:!0})}),v.tracerSettingsOptions.on("click",function(t){var e,i=$(t.currentTarget),r=i.attr("data-value"),o=i.find("input");return(e=y.indexOf(r))>-1?(y.splice(e,1),setTimeout(function(){o.prop("checked",!1)},0)):(y.push(r),setTimeout(function(){o.prop("checked",!0)},0)),$(t.target).blur(),!1}),v.tracerSettings.find('a:has(input[type="text"])').on("click",function(t){return $(t.currentTarget).find("input").focus(),$(t.target).blur(),!1}),v.tracerSettings.on("click",function(t){return!1}),$("#tracer-play").click(function(){b.clear(),$("#tracer-play").hide().prop("disabled","disabled"),$("#tracer-pause").show().prop("disabled",!1),m.continueBreakpoint()}),$("#tracer-pause").click(function(){$("#tracer-play").show().prop("disabled",!1),$("#tracer-pause").hide().prop("disabled","disabled"),$("#tracer-continue").prop("disabled",!1),$("#tracer-end").prop("disabled",!1),$("#tracer-abort").prop("disabled",!1),0===S&&(S=null,m.getStore(function(t){i(t)})),w&&clearTimeout(w)}),$("#tracer-continue").click(function(){b.clear(),m.continueBreakpoint()}),$("#tracer-end").click(function(){b.clear(),o(),$("#tracer-play").hide(),$("#tracer-pause").show().prop("disabled",!1),S=0,m.continueBreakpoint()}),$("#tracer-abort").click(function(){b.clear(),l("Execution aborted."),util.hide(v.notifications),t()})})(),g=new Parser,m=new Solver({queryInput:v.queryInput}),g.onStart=function(){v.spinner.show(),util.hide(v.notifications)},g.onError=function(t,e){v.spinner.hide(),util.hide(v.notifications),"source"===t&&($("#notification-parsing-error .type").text("source code"),$("#notification-parsing-error .mesg").text(e),util.show(v.parsingErrorNotification)),"query"===t&&($("#notification-parsing-error .type").text("query"),$("#notification-parsing-error .mesg").text(e),util.show(v.parsingErrorNotification))},g.onEnd=function(t,e,i){return v.spinner.hide(),util.hide(v.notifications),"source"===t?void m.setSource(e):"query"===t?i&&i.trace?void m.callQuery(e,{trace:!0}):void m.callQuery(e):void 0};var E;m.onStart=function(){v.spinner.show(),util.hide(v.notifications),E=new ExecutionTimer,E.onExceed=e,E.start(),l("Execution started"),v.queryButton.prop("disabled","disabled"),v.clearStore.prop("disabled","disabled"),f()},m.onError=function(t){E.stop(),$("#notification-query-error .mesg").text(t),v.queryErrorNotification.show()},m.onEnd=function(e){E.stop(),l("Execution finished"),t(e)},m.onBreakpoint=function(t){return v.switchTracing.bootstrapSwitch("state")?0===S?void m.continueBreakpoint():void p(t):void m.continueBreakpoint()},m.onStoreEvent=function(t){v.switchTracing.bootstrapSwitch("state")&&p(t)},m.getOptions=function(){return{persistentStore:v.switchPersistentStore.bootstrapSwitch("state")}};var T=CodeMirror.fromTextArea($("#source").get(0),{lineNumbers:!0,theme:"monokai",styleActiveLine:!0,matchBrackets:!0});$(".CodeMirror, #source-control").click(function(){return!1}),$("#source-col").click(function(){T.setCursor(T.lineCount(),0),T.focus()});var x=new Editor(T);x.onChange=function(t,e){e=e||{},e.forced=e.forced||!1,(v.switchAutocompilation.bootstrapSwitch("state")||e.forced)&&g.parse("source",t)},v.compileButton.click(function(){x.build({forced:!0})}),v.queryButton.click(function(){var t=v.queryInput.val();v.switchTracing.bootstrapSwitch("state")?(v.traceLogPanel.empty(),n(),g.parse("query",t,{trace:!0})):g.parse("query",t)}),v.queryInput.keypress(function(t){13===t.which&&v.queryButton.click()}),$("#notifications > div button.close").click(function(t){$(this).parent().fadeOut()}),v.clearStore.click(function(t){a()}),T.focus(),function(){var t=getParameterByName("gist");if(t){v.spinner.show();var e=new Gister({isAnonymous:!0});e.on("error",function(t){v.spinner.hide(),v.gistErrorNotification.find(".mesg").text(t.toString())}),e.on("gist",function(t){return v.spinner.hide(),t.files&&t.files["chrjs.chr"]?void x.setValue(t.files["chrjs.chr"].content):void v.gistErrorNotification.find(".mesg").text("Given Gist has no CHR code.")}),e.get(t)}}()}),ExecutionTimer.MAXEXECUTIONTIME=3e3,ExecutionTimer.prototype.start=function(t){var e=this;this.startDate=t||new Date,this.timer=setTimeout(function(){e.exceed()},this.maxExecutionTime)},ExecutionTimer.prototype.stop=function(t){this.stopDate=t||new Date,this.clearTimer()},ExecutionTimer.prototype.clearTimer=function(){this.timer&&(clearTimeout(this.timer),this.timer=null)},ExecutionTimer.prototype.exceed=function(){this.onExceed(),this.clearTimer()}},{"./editor":1,"./parser":3,"./solver":4,"./util":5}],3:[function(require,module,exports){function Parser(r,t){this.onStart=function(){},this.onEnd=function(){},this.onError=function(){},this.worker=new Worker(PARSERWORKER_URI),this._setEventListener()}module.exports=Parser;const BASE_URI=URI,PARSERWORKER_URI=BASE_URI+"/public/js/playground/parserworker.js";Parser.prototype.parse=function(r,t,e){e=e||{},this.onStart(),this.worker.postMessage({type:r,source:t,data:e})},Parser.prototype._setEventListener=function(){var r=this;this.worker.addEventListener("message",function(t){var e=t.data;return e.error?void r.onError(e.type,e.error):void r.onEnd(e.type,e.parsed,e.data)})}},{}],4:[function(require,module,exports){function Solver(n){function t(n){i.info=n,i.setupQueryInput()}function o(n){return n&&n.hasOwnProperty("error")?void i.onError(n.error):void i.onEnd(n)}function e(n){i.onBreakpoint(n)}function r(n){i.onStoreEvent(n)}var i=this;this._pluginConnected=!1,this._pluginConnectionTry=0,this.onStart=function(){},this.onError=function(){},this.onEnd=function(){},this.onBreakpoint=function(){},this.onStoreEvent=function(){},this.getOptions=function(){return{}},n=n||{},n.queryInput=n.queryInput||null;var u=new jailed.Plugin(CHRWORKER_URI,{setInfo:t,queryFinished:o,breakpoint:e,storeEvent:r});u.whenConnected(function(){u.remote.loadCHR(CHR_URI),i._pluginConnected=!0}),this.plugin=u,this.queryInput=n.queryInput}module.exports=Solver;const BASE_URI=URI,CHRWORKER_URI=BASE_URI+"/public/js/playground/chrworker.js",CHR_URI=BASE_URI+"/public/js/playground/chr-wop.js";Solver.RETRYTIME=200,Solver.MAXRETRIES=5,Solver.prototype.setSource=function(n){var t=this,o=this.getOptions()||{};return this._pluginConnected?(this.plugin.remote.setSource(n,o),void(this._pluginConnectionTry=0)):++this._pluginConnectionTry===Solver.MAXRETRIES?void this.onError("Could not connect to remote solver plugin."):void setTimeout(function(){t.setSource(n)},Solver.RETRYTIME)},Solver.prototype.callQuery=function(n,t){this.onStart(),this.plugin.remote.callQuery(n)},Solver.prototype.killConstraint=function(n){this.plugin.remote.killConstraint(n)},Solver.prototype.continueBreakpoint=function(){this.plugin.remote.continueBreakpoint()},Solver.prototype.getStore=function(n){this.plugin.remote.getStore(function(t){n(t)})},Solver.prototype.setupQueryInput=function(){var n=this;this.queryInput&&this.queryInput.textcomplete([{context:function(n){for(var t=0,o=0;o<n.length;o++)if("("===n[o]?t++:")"===n[o]&&t--,0>t)return!1;return 0===t},match:/(^|[\s,])([a-z][A-z0-9_]*)?$/,index:2,search:function(t,o){for(var e=[],r=0;r<n.info.functors.length;r++)0===n.info.functors[r].indexOf(t)&&e.push(n.info.functors[r]);o(e)},replace:function(n){var t=n.split("/")[0],o=parseInt(n.split("/")[1],10);return o>0?["$1"+t+"(",Array(o).join(",")+")"]:"$1"+t}}])}},{}],5:[function(require,module,exports){function show(e){e.removeClass("inactive")}function hide(e){e.addClass("inactive")}module.exports={},module.exports.show=show,module.exports.hide=hide},{}]},{},[2]);
